[workspace]
name = "tauri-test-cli"
version = "0.6.2"
description = "CLI for testing Tauri applications with screenshot capture, DOM inspection, and user interaction simulation"
channels = ["conda-forge"]
platforms = ["linux-64", "osx-arm64", "osx-64"]

# ============================================================================
# DEPENDENCIES (from conda-forge)
# ============================================================================

[dependencies]
# Rust toolchain (includes cargo)
rust = ">=1.70"
compilers = ">=1.11.0"
# Build tools
pkg-config = ">=0.29"
openssl = ">=3.0"

# This will work when it is published to conda-forge
# tauri-driver = "*"

# pnpm (fallback if bun not available)
pnpm = ">=10"

# ============================================================================
# Linux-specific dependencies
# ============================================================================
[target.linux-64.dependencies]
# WebKit for Tauri (Linux only - macOS uses native WebKit)
"webkit2gtk4.1" = ">=2.48"

# Note: For xvfb support, install via system package manager:
#   sudo apt install xvfb x11-utils  # Debian/Ubuntu
#   sudo dnf install xorg-x11-server-Xvfb xorg-x11-utils  # Fedora

# GTK/GUI stack (needed for Tauri on Linux)
gtk3 = ">=3.24"
glib = ">=2.70"
cairo = ">=1.16"
pango = ">=1.50"
atk = ">=2.38"
gdk-pixbuf = ">=2.42"
librsvg = ">=2.50"
libsoup = ">=3.0"
dbus = ">=1.14"
zlib = ">=1.2"
expat = ">=2.5"
fontconfig = ">=2.14"
freetype = ">=2.12"
harfbuzz = ">=8.0"

# ============================================================================
# TASKS
# ============================================================================

[tasks]
# Install bun (not available on conda-forge, uses official installer)
install-bun = "curl -fsSL https://bun.sh/install | bash"

# Build and development
generate-skill-content = "bun scripts/generate-skill-content.ts"
build = { cmd = "bun build ./src/cli.ts --outdir ./dist --target node", depends-on = ["generate-skill-content"] }
dev = "bun run ./src/cli.ts"
typecheck = "bun run tsc --noEmit"

# Testing
test = "bun test --timeout 10000"
test-watch = "bun test --watch"
test-unit = "bun test src/cli.test.ts src/checks.test.ts src/commands/utils.test.ts --timeout 10000"
test-integration = "bun test src/integration.test.ts --timeout 60000"
test-all = { cmd = "bun test --timeout 60000", depends-on = ["test-app-build"] }

# Install npm dependencies
install-deps = "bun install"

# Install tauri-driver from cargo
install-tauri-driver = "cargo install tauri-driver --locked"

# Full setup
setup = { cmd = "echo 'Setup complete! Run: pixi run build'", depends-on = ["install-deps", "install-tauri-driver"] }

# ============================================================================
# TESTING (requires a Tauri app binary)
# Usage: pixi run server -- --app /path/to/your/tauri-app
# ============================================================================

# Start server (requires --app argument)
server = "bun run ./src/cli.ts server"

# Start server with xvfb (Linux - avoids focus/throttling issues)
server-xvfb = "env -u WAYLAND_DISPLAY GDK_BACKEND=x11 xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' bun run ./src/cli.ts server"

# CLI commands (connect to running server on port 9222)
click = "bun run ./src/cli.ts click"
type = "bun run ./src/cli.ts type"
screenshot = "bun run ./src/cli.ts screenshot"
snapshot = "bun run ./src/cli.ts snapshot"
eval = "bun run ./src/cli.ts eval"
wait = "bun run ./src/cli.ts wait"

# Server management
status = "bun run ./src/cli.ts status"
stop = "bun run ./src/cli.ts stop"
cleanup = "bun run ./src/cli.ts cleanup"

# Quick curl commands for testing (assumes server is running)
curl-status = "curl -s http://127.0.0.1:9222/status"
curl-stop = "curl -s http://127.0.0.1:9222/stop"

# ============================================================================
# TEST APP (apps/test-app)
# ============================================================================

# Build the test app (using bash -c to ensure env vars are inherited)
test-app-build = "cd apps/test-app/src-tauri && cargo build"

# Run the test app directly (for manual testing)
test-app-run = { cmd = "cargo run", cwd = "apps/test-app/src-tauri" }

# Start server with test app
test-server = { cmd = "bun run ./src/cli.ts server --app ./apps/test-app/src-tauri/target/debug/test-app" }
test-server-xvfb = { cmd = "env -u WAYLAND_DISPLAY GDK_BACKEND=x11 xvfb-run --auto-servernum --server-args='-screen 0 1920x1080x24' bun run ./src/cli.ts server --app ./apps/test-app/src-tauri/target/debug/test-app" }

# ============================================================================
# BENCHMARKS (Claude Code headless testing)
# ============================================================================

# List available benchmark tasks
benchmark-list = "./benchmarks/run-benchmark.sh --list"

# Run a single benchmark with visualization
benchmark = "./benchmarks/run-benchmark.sh -v"

# Run all benchmarks
benchmark-all = { cmd = "./benchmarks/run-benchmark.sh --all", depends-on = ["test-app-build"] }

# Run all benchmarks quietly (just timing)
benchmark-all-quiet = { cmd = "./benchmarks/run-benchmark.sh --all --quiet", depends-on = ["test-app-build"] }

# Run benchmarks with specific model
benchmark-opus = { cmd = "./benchmarks/run-benchmark.sh --all -m opus", depends-on = ["test-app-build"] }
benchmark-haiku = { cmd = "./benchmarks/run-benchmark.sh --all -m haiku", depends-on = ["test-app-build"] }

# Check if all required tools are available
check-rust = "rustc --version"
check-cargo = "cargo --version"
check-pkg-config = "pkg-config --version"
check-pnpm = "pnpm --version"
check-webkit = "pkg-config --modversion webkit2gtk-4.1"
check-tools = { depends-on = ["check-rust", "check-cargo", "check-pkg-config", "check-pnpm", "check-webkit"] }

# ============================================================================
# VERSION & PUBLISHING
# ============================================================================

# Bump version (usage: pixi run bump -- patch|minor|major|x.y.z)
bump = "./scripts/bump-version.sh"
bump-patch = "./scripts/bump-version.sh patch"
bump-minor = "./scripts/bump-version.sh minor"
bump-major = "./scripts/bump-version.sh major"

# Publish to npm (interactive - asks for version bump type)
publish = "./scripts/publish.sh"

[system-requirements]
# My system has glibc=2.42, so we need to target glibc=2.39
libc = { family = "glibc", version = "2.39" }

[activation.env]
#   WebKitGTK (used by Tauri's webview on Linux) tries to use GPU-accelerated rendering via EGL/DMABuf
#   by default. Inside a pixi/conda environment, the Mesa/GPU libraries bundled by
#   conda often don't match your system's actual GPU drivers, causing WebKit to crash
#   or render a blank window. These env vars force WebKit into a software rendering
#   path that avoids those driver mismatches.
WEBKIT_DISABLE_DMABUF_RENDERER = "1"
WEBKIT_DISABLE_COMPOSITING_MODE = "1"
